generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String       @id
  name        String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  departments Department[]
  invoices    Invoice[]
  users       User[]

  @@map("organizations")
}

model Department {
  id             String       @id
  name           String?
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices       Invoice[]

  @@index([organizationId])
  @@map("departments")
}

model User {
  id                String        @id
  email             String        @unique
  name              String?
  role              String        @default("user")
  organizationId    String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  chatHistory       ChatHistory[]
  assignedInvoices  Invoice[]     @relation("AssignedTo")
  uploadedInvoices  Invoice[]     @relation("UploadedBy")
  validatedInvoices Invoice[]     @relation("ValidatedBy")
  organization      Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Invoice {
  id                 String           @id
  name               String
  filePath           String
  fileSize           BigInt
  fileType           String
  status             String           @default("pending")
  organizationId     String
  departmentId       String
  uploadedById       String
  assignedToId       String?
  assignedAt         DateTime?
  isValidatedByHuman Boolean          @default(false)
  validatedById      String?
  processedAt        DateTime?
  createdAt          DateTime
  updatedAt          DateTime
  analyticsId        String?
  extractedData      ExtractedData?
  metadata           InvoiceMetadata?
  assignedTo         User?            @relation("AssignedTo", fields: [assignedToId], references: [id])
  department         Department       @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  organization       Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedBy         User             @relation("UploadedBy", fields: [uploadedById], references: [id])
  validatedBy        User?            @relation("ValidatedBy", fields: [validatedById], references: [id])
  lineItems          LineItem[]
  payments           Payment[]
  validatedData      ValidatedData?

  @@index([organizationId])
  @@index([departmentId])
  @@index([uploadedById])
  @@index([status])
  @@index([createdAt])
  @@index([analyticsId])
  @@map("invoices")
}

model InvoiceMetadata {
  id                String   @id @default(cuid())
  invoiceId         String   @unique
  modelUsed         String?
  promptTokens      Int?
  completionTokens  Int?
  totalTokens       Int?
  processingTime    Float?
  confidence        Float?
  aiResponseBaseUrl String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  invoice           Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_metadata")
}

model ExtractedData {
  id                  String    @id @default(cuid())
  invoiceId           String    @unique
  vendorName          String?
  vendorAddress       String?
  vendorEmail         String?
  vendorPhone         String?
  vendorTaxId         String?
  customerName        String?
  customerAddress     String?
  customerEmail       String?
  customerPhone       String?
  invoiceNumber       String?
  invoiceDate         DateTime?
  dueDate             DateTime?
  purchaseOrderNumber String?
  subtotal            Decimal?  @db.Decimal(15, 2)
  taxAmount           Decimal?  @db.Decimal(15, 2)
  taxRate             Decimal?  @db.Decimal(5, 2)
  totalAmount         Decimal?  @db.Decimal(15, 2)
  currency            String?   @default("EUR")
  paymentTerms        String?
  paymentMethod       String?
  bankAccount         String?
  notes               String?
  category            String?   @default("Operations")
  validatedBy         String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  invoice             Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([vendorName])
  @@index([invoiceNumber])
  @@index([invoiceDate])
  @@index([category])
  @@map("extracted_data")
}

model ValidatedData {
  id            String    @id @default(cuid())
  invoiceId     String    @unique
  vendorName    String?
  vendorAddress String?
  invoiceNumber String?
  invoiceDate   DateTime?
  dueDate       DateTime?
  subtotal      Decimal?  @db.Decimal(15, 2)
  taxAmount     Decimal?  @db.Decimal(15, 2)
  totalAmount   Decimal?  @db.Decimal(15, 2)
  currency      String?   @default("EUR")
  category      String?
  status        String    @default("validated")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  invoice       Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("validated_data")
}

model LineItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(15, 2)
  amount      Decimal  @db.Decimal(15, 2)
  taxRate     Decimal? @db.Decimal(5, 2)
  taxAmount   Decimal? @db.Decimal(15, 2)
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("line_items")
}

model Payment {
  id            String   @id @default(cuid())
  invoiceId     String
  amount        Decimal  @db.Decimal(15, 2)
  paymentDate   DateTime
  paymentMethod String?
  transactionId String?
  status        String   @default("pending")
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paymentDate])
  @@map("payments")
}

model AnalyticsCache {
  id             String   @id @default(cuid())
  metricType     String
  periodType     String
  periodStart    DateTime
  periodEnd      DateTime
  organizationId String?
  departmentId   String?
  vendorName     String?
  category       String?
  value          Decimal  @db.Decimal(15, 2)
  count          Int?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([metricType, periodType, periodStart, periodEnd, organizationId, departmentId, vendorName, category])
  @@index([metricType, periodType])
  @@index([organizationId])
  @@map("analytics_cache")
}

model ChatHistory {
  id            Int      @id @default(autoincrement())
  userId        String?
  query         String
  sqlQuery      String?  @map("sql_query")
  results       Json?
  error         String?
  executionTime Int?     @map("executionTime")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("chat_history")
}
